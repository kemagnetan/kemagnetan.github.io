<!doctype html>
<html lang="en">
  <head>
  	<title>Halaman Guru</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	    <!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">
		
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="../css/style.css">
  </head>
  <body>
    <style>
        img{
            width: 150px;
            height: 150px;
            border: 2px solid black;
        }
    </style>
		
		<div class="wrapper d-flex align-items-stretch">
			<nav id="sidebar" class="active">
				<div class="custom-menu">
					<button type="button" id="sidebarCollapse" class="btn btn-primary">
	          <i class="fa fa-bars"></i>
	          <span class="sr-only">Toggle Menu</span>
	        </button>
        </div>
				<div class="p-4">
		  		<h1><a href="index.html" class="logo">Halaman Guru</a></h1>
	        <ul class="list-unstyled components mb-5">
	          <li class="active">
	            <a href="#"><span class="fa fa-briefcase mr-3"></span> Bank Soal</a>
	          </li>
	          <li>
	              <a href="../nilai/index.html"><span class="fa fa-briefcase mr-3"></span> Nilai Siswa</a>
	          </li>
	          <li>
              <a href="../jawaban/index.html"><span class="fa fa-briefcase mr-3"></span> Jawaban siswa</a>
	          </li>
	          <li>
              <a href="../kontrol/index.html"><span class="fa fa-briefcase mr-3"></span> Kontrol</a>
	          </li>
	        </ul>

	        <div class="mb-5">
					
					</div>

	        <div class="footer">
	        	<p>
                    Pada halaman ini anda dapat mengelola soal, mengunci kuis dan melihat jawaban siswa.
                </p>
	        </div>

	      </div>
    	</nav>

        <!-- Page Content  -->
        
      <div id="content" class="p-4 p-md-5 pt-5">
          <br>
        <h2 class="mb-4">Bank Soal </h2>
		<div class="btn-group">
			<a href="../index.html" class="btn btn-primary " aria-current="page">Kuis 1</a>
			<a href="kuis2.html" class="btn btn-primary ">Kuis 2</a>
			<a href="#" class="btn btn-primary active">Kuis 3</a>
			<a href="evaluasi.html" class="btn btn-primary">Evaluasi</a>
		  </div>
		  <!--badan konten tambah soal-->
		  <div class="container" style="margin-top: 50px;">
    

			<h4 class="text-center"> KUIS 3</h4>
		
			<h5># Tamah Soal</h5>
			<div class="card card-default">
				<div class="card-body">
					<form id="addSoal" method="POST" action="">
						<div class="form-group mx-sm-3 mb-2">
							
							<img id="myimg"><label id="upProgress"></label>
                            <br> <a style="color: red;">*Pilihlah gambar jika soal memiliki gambar</a><br>
							<input id="namebox" type="text" required autofocus></input>
							<button class="btn btn-primary btn-sm" id="select" >Pilih gambar</button>
						</div>
		
						<div class="form-group mx-sm-3 mb-2">
						Masukan redaksi soal disini :
						   <input style="height: 80px;width: 100%;"  id="soal" type="text"  name="soal"
								   required autofocus>
						</div>
		 
						<div class="form-group mx-sm-3 mb-2">
						   Pilihan A :
							<input style="border:1px solid grey;" class="form-control" id="opt1" type="text"  name="opt1" 
								   required autofocus>
						</div>
						<div class="form-group mx-sm-3 mb-2">
                            Pilihan B :
							<input style="border:1px solid grey;" class="form-control" id="opt2" type="text" name="opt2" 
								   required autofocus>
						</div>
		
						<div class="form-group mx-sm-3 mb-2">
							Pilihan C :
							<input style="border:1px solid grey;" class="form-control" id="opt3" type="text"  name="opt3" 
								   required autofocus>
						</div>
						<div class="form-group mx-sm-3 mb-2">
							Pilihan D :
							<input style="border:1px solid grey;" class="form-control" id="opt4" type="text"  name="opt4" 
								   required autofocus>
						</div>
						<div class="input-group mb-3">
							<div class="input-group-prepend">
							  <label class="input-group-text" for="kunci_jawaban">Options</label>
							</div>
							<select name="kunci_jawaban" id="kunci_jawaban" placeholder="Kunci Jawaban">
								<option  selected="selected" >Pilih Kunci Jawaban .....</option>
								<option>a</option>
								<option>b</option>
								<option>c</option>
								<option>d</option>
							  </select>
						  </div>
			
					   
		
						<button id="submitSoal" type="button" class="btn btn-primary">+ Tambah</button>
						<button onclick="getdata()" type="button" class="btn btn-dark">Tampilkan soal</button>
						<button onclick="fresh()" type="button" class="btn btn-outline-info">Refresh</button>
		
					</form>
				</div>
			</div>
		
			<br>
		
		
			<h5># database soal</h5>
			<table class="table table-bordered">
				<tr>
					<th>Gambar</th>
					<th>Soal</th>
					<th>Pilihan 1</th>
					<th>Pilihan 2</th>
					<th>Pilihan 3</th>
					<th>Pilihan 4</th>
					<th>Kunci jawaban</th>
					<th width="180" class="text-center">Action</th>
				</tr>
				<tbody id="tbodyg"></tbody>
				<tbody id="tbody">
		
				</tbody>
			</table>
		</div>
		
		<br>
		<br>
		<br>
		
		<!-- Update Model -->
		<form action="" method="POST" class="users-update-record-model form-horizontal">
			<div id="update-modal" data-backdrop="static" data-keyboard="false" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="custom-width-modalLabel"
				 aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered" style="width:55%;">
					<div class="modal-content" style="overflow: hidden;">
						<div class="modal-header">
							<h4 class="modal-title" id="custom-width-modalLabel">Update</h4>
							<button type="button" class="close" data-dismiss="modal"
									aria-hidden="true">×
							</button>
						</div>
						<div class="modal-body" id="updateBody">
		
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-light"
									data-dismiss="modal">Close
							</button>
							<button type="button" class="btn btn-success updateCustomer" data-dismiss="modal">Update
							</button>
						</div>
					</div>
				</div>
			</div>
		</form>
		
		<!-- Delete Model -->
		<form action="" method="POST" class="users-remove-record-model">
			<div id="remove-modal" data-backdrop="static" data-keyboard="false" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="custom-width-modalLabel"
				 aria-hidden="true" style="display: none;">
				<div class="modal-dialog modal-dialog-centered" style="width:55%;">
					<div class="modal-content">
						<div class="modal-header">
							<h4 class="modal-title" id="custom-width-modalLabel">Hapus</h4>
							<button type="button" class="close remove-data-from-delete-form" data-dismiss="modal"
									aria-hidden="true">×
							</button>
						</div>
						<div class="modal-body">
							<p>Apakah anda yakin ingin menghapus data ini?</p>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default waves-effect remove-data-from-delete-form"
									data-dismiss="modal">Close
							</button>
							<button type="button" class="btn btn-danger waves-effect waves-light deleteRecord">Hapus
							</button>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
	<script src="https://code.jquery.com/jquery-3.4.0.min.js"></script>
 <!--firebase libraries-->
 <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
 <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-storage.js"></script>
<script>
     var ImgName, ImgUrl;
        var files=[];
        var reader;
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyBZ0iLEVsHSFnGxxIhsILZCz6BLniCxIxg",
        authDomain: "crud-72352.firebaseapp.com",
        databaseURL: "https://crud-72352-default-rtdb.firebaseio.com",
        projectId: "crud-72352",
        storageBucket: "crud-72352.appspot.com",
        messagingSenderId: "288985518980",
        appId: "1:288985518980:web:c5eded2aa0e9970b0b83d1",
        measurementId: "G-HFDT60MD6C"
    };
    firebase.initializeApp(config);

    function fresh(){
        location.reload();
    }

    //mengambil data link gambar
    var emptyArray=[]; // array untuk menyimpan gambar link dari database
    var Namagambar=[]; // array untuk menyimpan gambar nama dari database
      
        //mengambil data link dari firebase
        $(document).ready(function(){
            var rootRef = firebase.database().ref().child("gambar3/");
            rootRef.on("child_added", snap => {
            var id = snap.child("Link").val();
            emptyArray.push(id); // push link gambar ke emptyarray
            });
            
        
        });
         //mengambil data link dari firebase
            $(document).ready(function(){
            var rotRef = firebase.database().ref().child("gambar3/");
            rotRef.on("child_added", snap => {
            var idd = snap.child("Nama").val();
            Namagambar.push(idd); // push nama gambar ke Namagambar
            });
            
        
        });
        console.log(Namagambar);

      //select =======================================================
     //pilih gambar
     document.getElementById("select").onclick= function(e){
                var input = document.createElement('input');
                input.type='file';
                input.click();

                input.onchange=e=>{
                    files=e.target.files;
                    reader = new FileReader();
                    reader.onload=function(){
                        document.getElementById("myimg").src = reader.result;
                    }
                    reader.readAsDataURL(files[0]);
                    var name= getNama(files[0]);

                    namebox.value= name;
                }
                function getNama(file){
                    var tamp = file.name;
                    return tamp;
                }
            }
         
    //CRUD firebase data base=================================================
    var database = firebase.database();
    let lastIndex=0;
    
 
   function getdata() {


    firebase.database().ref('soalKuis3/').on('value', function (snapshot) {
        var value = snapshot.val();
        var htmls = [];
        
        let ii=0;
        
        $.each(value, function (index, value) {
            var Gambar;
            if (value) {
                if(value.soalid==Namagambar[ii]){
                    Gambar=emptyArray[ii];
                }else{
                    Gambar="https://img.icons8.com/ios/200/000000/no-image.png";
                }
                htmls.push('<tr>\
                <td >'+'<img src="'+Gambar+'">'+'</td>\
        		<td>' + value.soal + '</td>\
        		<td>' + value.opt1 + '</td>\
                <td>' + value.opt2 + '</td>\
                <td>' + value.opt3 + '</td>\
                <td>' + value.opt4 + '</td>\
                <td>' + value.kunci_jawaban + '</td>\
        		<td><button data-toggle="modal" data-target="#update-modal" class="btn btn-info updateData" data-id="' + index + '">Update</button>\
        		<button data-toggle="modal" data-target="#remove-modal" class="btn btn-danger removeData" data-id="' + index + '">Delete</button></td>\
        	</tr>');
            ii++;
            }
            lastIndex = index;
        });
       
        $('#tbody').html(htmls);
        $("#submitUser").removeClass('desabled');
    });
    }

    // Add Data
    $('#submitSoal').on('click', function () {
       
            
        var values = $("#addSoal").serializeArray();
        var soal = values[0].value;
        var opt1 = values[1].value;
        var opt2 = values[2].value;
        var opt3 = values[3].value;
        var opt4 = values[4].value;
        var kunci_jawaban = values[5].value;
        let userID = lastIndex + 1;


       var namebox = document.getElementById("namebox").value;
        if (namebox != ""){
            
            //tambah data ke firbase storage dan folder gambar3 (gambar kuis3)
            ImgName = userID;
           var uploadTask = firebase.storage().ref('kuis3/'+ImgName+".png").put(files[0]);
                
                uploadTask.on('state_changed', function(snapshot){
                    var progress = (snapshot.bytesTranferred/snapshot.totalBytes)*100;
                    document.getElementById('upProgress').innerHTML='Upload'+progress+'%';
                },
                function (error){
                    alert('Gagal menyimpan gambar');
                },
                function(){
                    uploadTask.snapshot.ref.getDownloadURL().then(function(url){
                        ImgUrl = url;
                    
                    firebase.database().ref('gambar3/'+ImgName).set({
                        Nama:ImgName,
                        Link:ImgUrl
                    });
                    alert('Gambar berhasil ditambahkan');
                    location.reload();
                }
                );
            });
        } 
            var ab="none";
            firebase.database().ref('gambar3/'+userID).set({
                        Nama:ab,
                        Link:ab
                    });
       
            // menambahkan data ke firbase database
            firebase.database().ref('soalKuis3/' + userID).set({
                soalid:userID,
                soal: soal,
                opt1: opt1,
                opt2: opt2,
                opt3: opt3,
                opt4: opt4,
                kunci_jawaban: kunci_jawaban,

            });

            // Reassign lastID value
            lastIndex = userID;
            $("#addSoal input").val("");

        
    });

    // Update Data
    var updateID = 0;
    $('body').on('click', '.updateData', function () {
        updateID = $(this).attr('data-id');
        firebase.database().ref('soalKuis3/' + updateID).on('value', function (snapshot) {
            var values = snapshot.val();
            var updateData = '<input id="soalid" type="text" style="pointer-events:none; background-color: rgb(7, 182, 138); color:white;" class="form-control" name="soal" value="' + values.soalid + '" required autofocus>\
            <div class="form-group">\
		        <label for="first_name" class="col-md-12 col-form-label">Soal</label>\
		        <div class="col-md-12">\
		            <input id="first_name" type="text" style="border:1px solid green;" class="form-control" name="soal" value="' + values.soal + '" required autofocus>\
		        </div>\
		    </div>\
		    <div class="form-group">\
		        <label for="last_name" class="col-md-12 col-form-label">Pilihan 1</label>\
		        <div class="col-md-12">\
		            <input id="last_name" type="text" style="border:1px solid green;" class="form-control" name="opt1" value="' + values.opt1 + '" required autofocus>\
		        </div>\
            <div class="form-group">\
		        <label for="last_name" class="col-md-12 col-form-label">Pilihan 2</label>\
		        <div class="col-md-12">\
		            <input id="last_name" type="text" style="border:1px solid green;" class="form-control" name="opt2" value="' + values.opt2 + '" required autofocus>\
		    </div>\
            <div class="form-group">\
		        <label for="last_name" class="col-md-12 col-form-label">Pilihan 3</label>\
		        <div class="col-md-12">\
		            <input id="last_name" type="text" style="border:1px solid green;" class="form-control" name="oopt3pt2" value="' + values.opt3 + '" required autofocus>\
		    </div>\
            <div class="form-group">\
		        <label for="last_name" class="col-md-12 col-form-label">Pilihan 4</label>\
		        <div class="col-md-12">\
		            <input id="last_name" type="text" style="border:1px solid green;" class="form-control" name="opt4" value="' + values.opt4 + '" required autofocus>\
		    </div>\
            <div class="form-group">\
		        <label for="last_name" class="col-md-12 col-form-label">Kunci Jawaban</label>\
		        <div class="col-md-12">\
		            <input id="last_name" type="text" style="border:1px solid green;" class="form-control" name="kunci_jawaban" value="' + values.kunci_jawaban + '" required autofocus>\
		    </div>\
		    </div>'
            ;

            $('#updateBody').html(updateData);
        });
    });

    $('.updateCustomer').on('click', function () {
        var values = $(".users-update-record-model").serializeArray();
        var postData = {
            soalid : values[0].value,
            soal : values[1].value,
            opt1 : values[2].value,
            opt2 : values[3].value,
            opt3 : values[4].value,
            opt4 : values[5].value,
            kunci_jawaban : values[6].value
            

        };

        var updates = {};
        updates['/soalKuis3/' + updateID] = postData;

        firebase.database().ref().update(updates);

        $("#update-modal").modal('hide');
    });

    // Remove Data
    $("body").on('click', '.removeData', function () {
        var id = $(this).attr('data-id');
        $('body').find('.users-remove-record-model').append('<input name="id" type="hidden" value="' + id + '">');
    });

    $('.deleteRecord').on('click', function () {
        var values = $(".users-remove-record-model").serializeArray();
        var id = values[0].value;
        firebase.database().ref('soalKuis3/' + id).remove();//menghapus data pada soal kuis
        firebase.database().ref('gambar3/' + id).remove();//menghapus data pada gambar soal
        //===================menghapus file firebase storage======================
  // Create a reference to the file to delete
            var desertRef =  firebase.storage().ref('kuis3/'+id+'.png');

            // Delete the file
            desertRef.delete().then(function() {
            //alert("File deleted successfully");
            }).catch(function(error) {
            // Uh-oh, an error occurred!
            });

        //====================================================
        $('body').find('.users-remove-record-model').find("input").remove();
        $("#remove-modal").modal('hide');
    });
    $('.remove-data-from-delete-form').click(function () {
        $('body').find('.users-remove-record-model').find("input").remove();
    });


    // //delete link gambar
    // function deletelink(){
    //     const userID = e.target.getAttribute("userid");
    //     const userRef = dbRef.child('users/' + userID);
    //     userRef.remove()
        
    

    // }
</script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/popper.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/main.js"></script>
  </body>
</html>